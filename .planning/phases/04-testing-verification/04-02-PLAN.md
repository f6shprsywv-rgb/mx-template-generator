---
phase: 04-testing-verification
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - server.js
  - .planning/phases/04-testing-verification/FIX-VERIFICATION.md
autonomous: false

must_haves:
  truths:
    - "All previously failing imports now succeed"
    - "Generated templates pass ISA-88 structure validation"
    - "structureDisplay present on PHASE_STEP nodes (if required)"
    - "CORRECTION children present on DATA_ENTRY steps (if required)"
  artifacts:
    - path: "server.js"
      provides: "Updated template generation with import fixes"
      contains: "validateTemplateStructure"
    - path: ".planning/phases/04-testing-verification/FIX-VERIFICATION.md"
      provides: "Verification that fixes work"
  key_links:
    - from: "server.js addPhaseWithOptions"
      to: "ISA-88 compliant output"
      via: "structureDisplay and CORRECTION child generation"
      pattern: "structureDisplay|CORRECTION"
---

<objective>
Fix any import failures discovered in Plan 01 and verify all templates import successfully.

Purpose: Ensure generated templates pass MasterControl Mx import validation. Based on ANALYSIS.md, common issues include missing structureDisplay and CORRECTION children.
Output: Working template generation that passes real-world import tests.
</objective>

<execution_context>
@/Users/kfarley@mastercontrol.com/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kfarley@mastercontrol.com/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-testing-verification/04-01-SUMMARY.md
@.planning/phases/04-testing-verification/IMPORT-RESULTS.md
@ANALYSIS.md
@server.js

Key understanding from ANALYSIS.md:
- structureDisplay required on DATA_ENTRY PHASE_STEPs
- CORRECTION child (SUB_PHASE_STEP) required on DATA_ENTRY steps
- dataCaptureSteps need proper types: GENERAL_TEXT, GENERAL_NUMERIC, NOTES, SIGN_OFF
</context>

<tasks>

<task type="auto">
  <name>Task 1: Analyze import failures and implement fixes</name>
  <files>server.js</files>
  <action>
Based on IMPORT-RESULTS.md from Plan 01, identify the root causes of any import failures.

**If imports SUCCEEDED:**
- Document success in FIX-VERIFICATION.md
- No code changes needed

**If imports FAILED with specific errors:**
Reference ANALYSIS.md for known gap patterns:

1. **Missing structureDisplay on PHASE_STEP:**
   - Add structureDisplay generation when cloning DATA_ENTRY steps
   - Pattern: `structureDisplay: { structureId: <step_id>, displayOrderNumber: <order> }`

2. **Missing CORRECTION child on DATA_ENTRY:**
   - Ensure addPhaseWithOptions copies CORRECTION child when cloning DATA_ENTRY
   - Must have correctionType: "PRIMARY_DATA_ENTRY"
   - Must have 3 dataCaptureSteps: CORRECTION_START, CORRECTION_END, CORRECTION_CANCEL

3. **Missing required fields on dataCaptureSteps:**
   - Ensure all dataCaptureSteps have: id, localReferenceId, structureId, allValuesCurrent, autoCaptured, optionalStep, primaryStep, etc.

4. **UUID uniqueness issues:**
   - Verify regenerateUUIDs function covers all localReferenceId fields

**Implementation approach:**
- Modify addPhaseWithOptions() in server.js to handle identified issues
- Ensure updateUUIDs() inside addPhaseWithOptions regenerates all required UUIDs
- Add any missing required fields when creating new elements
  </action>
  <verify>grep -n "structureDisplay\|CORRECTION\|dataCaptureSteps" server.js shows relevant code exists</verify>
  <done>server.js updated with fixes for identified import issues, or documented that no fixes needed</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Re-test imports with fixes</name>
  <what-built>Fixes applied based on Plan 01 test results. Need to verify fixes work.</what-built>
  <how-to-verify>
**Re-execute any previously failing tests:**

1. Access https://mx-template-generator-production.up.railway.app/
2. For each test that failed in Plan 01:
   - Generate new template with same inputs
   - Download .mt file
   - Import to MasterControl Mx
   - Record result: SUCCESS / STILL FAILING

**Verify successful imports:**
1. Open imported template in MasterControl Mx
2. Confirm structure is correct:
   - Phases appear in correct order
   - Phase steps are visible and editable
   - Sign-off options (witness/verify) work if requested

**Document in FIX-VERIFICATION.md:**
- List of fixes applied
- Before/after test results
- Any remaining issues
  </how-to-verify>
  <resume-signal>Type "verified" with test results, or describe remaining issues</resume-signal>
</task>

</tasks>

<verification>
Phase verification:
1. All previously failing imports now succeed
2. FIX-VERIFICATION.md documents before/after results
3. Generated templates are ready for competition demo
</verification>

<success_criteria>
- All basic clone tests import successfully to MasterControl Mx
- All "add phase" modification tests import successfully
- Phase additions with witness/verify properties work correctly
- No import errors remain
- Demo-ready: user can generate and import templates reliably
</success_criteria>

<output>
After completion, create `.planning/phases/04-testing-verification/04-02-SUMMARY.md`
</output>
