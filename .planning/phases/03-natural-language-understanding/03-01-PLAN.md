---
phase: 03-natural-language-understanding
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - /Users/kfarley@mastercontrol.com/mx-template-generator/server.js
  - /Users/kfarley@mastercontrol.com/mx-template-generator/package.json
  - /Users/kfarley@mastercontrol.com/mx-template-generator/.env.example
autonomous: true
user_setup:
  - service: anthropic
    why: "Claude API for NLP processing and JSON modification"
    env_vars:
      - name: ANTHROPIC_API_KEY
        source: "https://console.anthropic.com/settings/keys -> Create Key"
    dashboard_config: []

must_haves:
  truths:
    - "User's natural language request is sent to Claude API"
    - "Claude returns modified JSON based on the request"
    - "Modified template downloads with requested changes applied"
    - "ISA-88 hierarchy preserved in modified template"
  artifacts:
    - path: "/Users/kfarley@mastercontrol.com/mx-template-generator/server.js"
      provides: "Claude API integration in /api/generate endpoint"
      contains: "Anthropic"
    - path: "/Users/kfarley@mastercontrol.com/mx-template-generator/package.json"
      provides: "Anthropic SDK dependency"
      contains: "@anthropic-ai/sdk"
    - path: "/Users/kfarley@mastercontrol.com/mx-template-generator/.env.example"
      provides: "Environment variable documentation"
      contains: "ANTHROPIC_API_KEY"
  key_links:
    - from: "/Users/kfarley@mastercontrol.com/mx-template-generator/server.js"
      to: "Claude API"
      via: "Anthropic SDK client.messages.create()"
      pattern: "anthropic\\.messages\\.create"
    - from: "/Users/kfarley@mastercontrol.com/mx-template-generator/server.js"
      to: "Template JSON"
      via: "JSON.parse of Claude response"
      pattern: "JSON\\.parse.*response"
---

<objective>
Integrate Claude API to process natural language requests and modify MasterControl Mx templates.

Purpose: Enable the core functionality - user describes changes, Claude understands and modifies the template JSON.
Output: Working /api/generate endpoint that actually modifies templates based on user requests.
</objective>

<execution_context>
@/Users/kfarley@mastercontrol.com/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kfarley@mastercontrol.com/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/kfarley@mastercontrol.com/mx-template-generator/server.js
@/Users/kfarley@mastercontrol.com/mx-template-generator/package.json
@/Users/kfarley@mastercontrol.com/mx-template-generator/templates/baseline-minimal.mt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Anthropic SDK and create environment template</name>
  <files>
    /Users/kfarley@mastercontrol.com/mx-template-generator/package.json
    /Users/kfarley@mastercontrol.com/mx-template-generator/.env.example
  </files>
  <action>
1. Install the Anthropic SDK:
   ```bash
   cd /Users/kfarley@mastercontrol.com/mx-template-generator && npm install @anthropic-ai/sdk
   ```

2. Create `.env.example` file to document required environment variables:
   ```
   PORT=3000
   NODE_ENV=development
   ANTHROPIC_API_KEY=your-api-key-here
   ```

This file serves as documentation for what env vars are needed. The actual .env file (which contains real keys) is gitignored.
  </action>
  <verify>
    Run `npm ls @anthropic-ai/sdk` - should show the package installed
    Verify `.env.example` exists with ANTHROPIC_API_KEY placeholder
  </verify>
  <done>
    Anthropic SDK is in package.json dependencies
    .env.example documents required ANTHROPIC_API_KEY
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate Claude API into /api/generate endpoint</name>
  <files>
    /Users/kfarley@mastercontrol.com/mx-template-generator/server.js
  </files>
  <action>
Modify the `/api/generate` endpoint in server.js to:

1. Import Anthropic SDK at top of file:
   ```javascript
   const Anthropic = require('@anthropic-ai/sdk').default;
   const anthropic = new Anthropic(); // Uses ANTHROPIC_API_KEY env var automatically
   ```

2. Replace the TODO comment section in `/api/generate` with Claude API call:

   a. Create a detailed system prompt that explains:
      - The ISA-88 hierarchy structure (PROCEDURE > UNIT_PROCEDURE > OPERATION > PHASE > PHASE_STEP)
      - Required fields for each level (id, globalSerialId, localReferenceId, title, type, level, children, etc.)
      - How to generate new UUIDs using the format shown in the template
      - The relationship between parentId and the parent's id field
      - The orderNumber fields and how they work
      - That dataCaptureSteps must be preserved with their structure

   b. Send the baseline template JSON + user request to Claude with:
      - model: "claude-sonnet-4-20250514" (fast and capable, within free tier)
      - max_tokens: 16000 (templates can be large)
      - System prompt explaining Mx template structure
      - User message with: the baseline template JSON + the user's modification request

   c. Parse Claude's response as JSON and use it as the modified template

   d. Apply UUID regeneration to the Claude-modified template (using existing regenerateUUIDs function)

   e. Handle errors gracefully - if Claude fails or returns invalid JSON, fall back to just UUID regeneration with an error message

3. The system prompt should include this key information about Mx templates:

```
You are a MasterControl Mx template modifier. You receive a baseline template JSON and a user request, and you return the modified template JSON.

STRUCTURE (ISA-88 hierarchy):
- PROCEDURE (level: "PROCEDURE") - The root/master template
  - UNIT_PROCEDURE (level: "UNIT_PROCEDURE") - Major sections
    - OPERATION (level: "OPERATION") - Groups of phases
      - PHASE (level: "PHASE") - Individual process phases
        - PHASE_STEP (level: "PHASE_STEP") - Steps within phases

KEY RULES:
1. Always preserve the hierarchy - children must have correct parentId pointing to parent's id
2. Each node needs: id (number), globalSerialId (UUID), localReferenceId (UUID), title, type, level, children array
3. Order numbers: unitProcedureOrderNumber, operationOrderNumber, phaseOrderNumber, phaseStepOrderNumber (1-based, *1000 for steps)
4. Keep masterTemplateId consistent (points to root PROCEDURE id)
5. Preserve dataCaptureSteps arrays - these define data capture behavior
6. When adding new nodes, generate placeholder IDs (any number) - they'll be regenerated

COMMON MODIFICATIONS:
- "Add a phase for X" - Create new PHASE node with title "X" as child of appropriate OPERATION
- "Add a step for Y" - Create new PHASE_STEP with title "Y" as child of appropriate PHASE
- "Rename X to Y" - Find node with title containing X, change title to Y
- "Add an operation for Z" - Create new OPERATION as child of UNIT_PROCEDURE

Return ONLY valid JSON - no explanation, no markdown code blocks, just the modified template JSON.
```

4. Keep the async/await pattern clean:
   ```javascript
   app.post('/api/generate', async (req, res) => {
     // ... existing validation ...

     try {
       const message = await anthropic.messages.create({
         model: "claude-sonnet-4-20250514",
         max_tokens: 16000,
         system: SYSTEM_PROMPT,
         messages: [
           {
             role: "user",
             content: `Baseline template:\n${JSON.stringify(templateData, null, 2)}\n\nUser request: ${request}\n\nReturn the modified template JSON only.`
           }
         ]
       });

       // Extract text content from response
       const responseText = message.content[0].text;
       let modifiedTemplate = JSON.parse(responseText);

       // Regenerate UUIDs for safety
       modifiedTemplate = regenerateUUIDs(modifiedTemplate);

       // ... rest of response ...
     } catch (error) {
       // ... error handling ...
     }
   });
   ```
  </action>
  <verify>
    1. Start server locally: `cd /Users/kfarley@mastercontrol.com/mx-template-generator && npm start`
    2. Test with curl:
       ```bash
       curl -X POST http://localhost:3000/api/generate \
         -H "Content-Type: application/json" \
         -d '{"templateId": "baseline-minimal", "request": "Add a new phase called Quality Check"}'
       ```
    3. Response should contain modified template with the new phase added
    4. Verify the response JSON has the new "Quality Check" phase in the structure
  </verify>
  <done>
    /api/generate endpoint calls Claude API with template + user request
    Claude's modified JSON is returned as the template
    UUIDs are regenerated after Claude's modifications
    Error handling falls back gracefully if Claude fails
  </done>
</task>

<task type="auto">
  <name>Task 3: Add loading state feedback and error messages to UI</name>
  <files>
    /Users/kfarley@mastercontrol.com/mx-template-generator/public/index.html
  </files>
  <action>
Update the UI to provide better feedback during Claude API calls:

1. Update the loading message to indicate AI processing:
   Change "Generating your template..." to "AI is modifying your template..."

2. Update success message to indicate what was done:
   Change to "Success! Your template has been modified based on your request."

3. Add timeout handling in the JavaScript fetch call:
   - Add a longer timeout (60 seconds) since Claude API calls can take time
   - Show appropriate message if timeout occurs

4. Update error message handling to show Claude-specific errors:
   - If Claude returns an error, show "AI processing failed - downloaded template has new IDs but no modifications"
   - If JSON parsing fails, show similar fallback message

The existing UI structure is good - just update the messaging to reflect that AI is doing the modification.
  </action>
  <verify>
    1. Open http://localhost:3000 in browser
    2. Select a template and enter a modification request
    3. Click Generate - should see "AI is modifying your template..."
    4. On success, should see updated success message
    5. Download should work and contain modified template
  </verify>
  <done>
    Loading state shows "AI is modifying your template..."
    Success message reflects that AI modifications were applied
    Error messages explain fallback behavior clearly
    Timeout handling prevents hanging on slow Claude responses
  </done>
</task>

</tasks>

<verification>
1. API Integration Test:
   ```bash
   # Ensure ANTHROPIC_API_KEY is set in .env
   cd /Users/kfarley@mastercontrol.com/mx-template-generator && npm start

   # In another terminal:
   curl -X POST http://localhost:3000/api/generate \
     -H "Content-Type: application/json" \
     -d '{"templateId": "baseline-minimal", "request": "Add a new phase called Quality Check after the existing Phase"}'
   ```
   Expected: Response contains modified template with "Quality Check" phase

2. End-to-End Test:
   - Open http://localhost:3000
   - Select "Minimal Baseline Template"
   - Enter: "Add a phase for Equipment Setup and a phase for Final Inspection"
   - Click Generate
   - Download the file
   - Verify the JSON contains the new phases

3. Import Test (manual):
   - Upload generated .mt file to MasterControl Mx
   - Verify it imports without errors
   - Verify the structure shows the requested modifications
</verification>

<success_criteria>
- Anthropic SDK installed and configured
- /api/generate endpoint sends template + request to Claude API
- Claude returns modified JSON following ISA-88 structure
- Modified template downloads with requested changes applied
- UI provides clear feedback during AI processing
- Generated templates import successfully into MasterControl Mx
</success_criteria>

<output>
After completion, create `.planning/phases/03-natural-language-understanding/03-01-SUMMARY.md`
</output>
