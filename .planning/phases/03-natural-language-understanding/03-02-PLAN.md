---
phase: 03-natural-language-understanding
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - /Users/kfarley@mastercontrol.com/mx-template-generator/server.js
autonomous: false

must_haves:
  truths:
    - "Invalid Claude responses don't crash the server"
    - "Malformed JSON from Claude is handled gracefully"
    - "User sees clear error if modification fails"
    - "Template structure is validated before returning"
  artifacts:
    - path: "/Users/kfarley@mastercontrol.com/mx-template-generator/server.js"
      provides: "JSON validation and error recovery"
      contains: "validateTemplateStructure"
  key_links:
    - from: "/Users/kfarley@mastercontrol.com/mx-template-generator/server.js"
      to: "Template validation"
      via: "validateTemplateStructure function"
      pattern: "validateTemplateStructure"
---

<objective>
Add validation and robust error handling to ensure Claude's modifications produce valid, importable templates.

Purpose: Prevent bad AI outputs from breaking imports - validate structure, handle edge cases, provide clear feedback.
Output: Bulletproof /api/generate that always returns a valid template (original if modification fails).
</objective>

<execution_context>
@/Users/kfarley@mastercontrol.com/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kfarley@mastercontrol.com/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/kfarley@mastercontrol.com/mx-template-generator/server.js
@/Users/kfarley@mastercontrol.com/mx-template-generator/.planning/phases/03-natural-language-understanding/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add template structure validation</name>
  <files>
    /Users/kfarley@mastercontrol.com/mx-template-generator/server.js
  </files>
  <action>
Add a validation function to verify Claude's output maintains valid Mx template structure:

```javascript
// Validate template structure follows ISA-88 hierarchy
function validateTemplateStructure(template) {
  const errors = [];

  // Root level checks
  if (!template.level || template.level !== 'PROCEDURE') {
    errors.push('Root must be level PROCEDURE');
  }
  if (!template.masterTemplateDetails) {
    errors.push('Missing masterTemplateDetails');
  }
  if (!Array.isArray(template.children)) {
    errors.push('Root must have children array');
  }

  // Recursive validation
  function validateNode(node, expectedLevel, parentId) {
    if (!node.globalSerialId) {
      errors.push(`Node "${node.title}" missing globalSerialId`);
    }
    if (!node.localReferenceId) {
      errors.push(`Node "${node.title}" missing localReferenceId`);
    }
    if (node.level !== expectedLevel) {
      errors.push(`Node "${node.title}" has wrong level: ${node.level}, expected ${expectedLevel}`);
    }

    // Validate children
    if (Array.isArray(node.children)) {
      const childLevels = {
        'PROCEDURE': 'UNIT_PROCEDURE',
        'UNIT_PROCEDURE': 'OPERATION',
        'OPERATION': 'PHASE',
        'PHASE': 'PHASE_STEP'
      };
      const expectedChildLevel = childLevels[expectedLevel];

      node.children.forEach(child => {
        if (expectedChildLevel) {
          validateNode(child, expectedChildLevel, node.id);
        }
      });
    }
  }

  validateNode(template, 'PROCEDURE', null);

  return {
    valid: errors.length === 0,
    errors: errors
  };
}
```

Use this in /api/generate after parsing Claude's response:
1. Validate Claude's output
2. If invalid, log the errors and fall back to UUID-regenerated original
3. Include validation status in response so user knows if AI modification worked
  </action>
  <verify>
    Create a test with intentionally malformed template to verify validation catches errors:
    ```javascript
    // Test in Node REPL or temporary test file
    const badTemplate = { title: "Bad", level: "WRONG" };
    const result = validateTemplateStructure(badTemplate);
    console.log(result); // Should show errors
    ```
  </verify>
  <done>
    validateTemplateStructure function exists
    Checks ISA-88 hierarchy levels
    Verifies required UUID fields exist
    Returns list of errors if invalid
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement graceful fallback and response enrichment</name>
  <files>
    /Users/kfarley@mastercontrol.com/mx-template-generator/server.js
  </files>
  <action>
Enhance the /api/generate error handling:

1. Wrap Claude API call in try-catch with specific error types:
   - API error (rate limit, auth, etc.)
   - JSON parse error (Claude returned non-JSON)
   - Validation error (Claude returned invalid structure)

2. For each error type, fall back gracefully:
   ```javascript
   let modifiedTemplate;
   let aiModified = false;
   let aiError = null;

   try {
     const message = await anthropic.messages.create({...});
     const responseText = message.content[0].text;

     // Try to extract JSON if Claude wrapped it in markdown
     let jsonText = responseText;
     const jsonMatch = responseText.match(/```json?\s*([\s\S]*?)\s*```/);
     if (jsonMatch) {
       jsonText = jsonMatch[1];
     }

     modifiedTemplate = JSON.parse(jsonText);

     // Validate structure
     const validation = validateTemplateStructure(modifiedTemplate);
     if (!validation.valid) {
       console.error('Validation errors:', validation.errors);
       throw new Error('Invalid template structure: ' + validation.errors.join(', '));
     }

     aiModified = true;
   } catch (error) {
     console.error('AI modification failed:', error.message);
     aiError = error.message;
     // Fall back to original template
     modifiedTemplate = templateData;
   }

   // Always regenerate UUIDs
   modifiedTemplate = regenerateUUIDs(modifiedTemplate);
   ```

3. Include AI status in response:
   ```javascript
   res.json({
     success: true,
     aiModified: aiModified,
     aiError: aiError,
     filename: filename,
     template: modifiedTemplate
   });
   ```

4. Update UI to show AI status:
   - If aiModified: true, show "AI modifications applied successfully!"
   - If aiModified: false, show "AI couldn't apply changes. Downloaded template has fresh IDs only."
  </action>
  <verify>
    Test with ANTHROPIC_API_KEY unset or invalid:
    ```bash
    # Temporarily rename .env
    cd /Users/kfarley@mastercontrol.com/mx-template-generator
    mv .env .env.backup
    npm start

    # In another terminal - should fall back gracefully
    curl -X POST http://localhost:3000/api/generate \
      -H "Content-Type: application/json" \
      -d '{"templateId": "baseline-minimal", "request": "Add a phase"}'

    # Restore
    mv .env.backup .env
    ```
    Response should have aiModified: false, aiError with message, but still return valid template
  </verify>
  <done>
    Claude API errors caught and handled
    JSON parse errors handled (including markdown extraction)
    Validation errors trigger fallback
    Response includes aiModified and aiError fields
    User always gets a valid, downloadable template
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Claude API integration with validation and fallback handling</what-built>
  <how-to-verify>
1. Open https://mx-template-generator-production.up.railway.app (or local http://localhost:3000)

2. Test successful modification:
   - Select "Minimal Baseline Template"
   - Enter: "Add a new phase called Quality Verification after the existing Phase"
   - Click Generate
   - Download the .mt file
   - Open in text editor and search for "Quality Verification" - should exist

3. Test import in MasterControl Mx:
   - Go to your MasterControl Mx instance
   - Navigate to Master Templates
   - Import the generated .mt file
   - Verify it imports without errors
   - Verify the "Quality Verification" phase appears in the structure

4. Test more complex modification:
   - Select "Standard" baseline template
   - Enter: "Add an operation called 'Equipment Setup' with two phases: 'Calibration' and 'Verification'"
   - Generate and download
   - Verify the nested structure exists in the JSON
  </how-to-verify>
  <resume-signal>Type "approved" if templates import correctly with AI modifications, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Validation Function Test:
   - Pass a known-good template - should return valid: true
   - Pass a template missing globalSerialId - should return valid: false with error

2. Fallback Test:
   - Unset ANTHROPIC_API_KEY
   - Make API request
   - Should return template with aiModified: false but still downloadable

3. End-to-End Test:
   - Make modification request
   - Download result
   - Import into MasterControl Mx
   - Verify changes appear and template functions correctly
</verification>

<success_criteria>
- Template structure validation catches malformed Claude outputs
- Graceful fallback returns valid template even if AI fails
- Response includes aiModified status for UI feedback
- User always gets importable template (modified or original with new IDs)
- Complex modification requests (nested structures) work correctly
- Generated templates import and function in MasterControl Mx
</success_criteria>

<output>
After completion, create `.planning/phases/03-natural-language-understanding/03-02-SUMMARY.md`
</output>
